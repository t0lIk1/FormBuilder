<!doctype html>
<html>
<head>
	<title>WebSocket Comments</title>
	<style>
      body {
          font-family: Arial, sans-serif;
          max-width: 800px;
          margin: 0 auto;
          padding: 20px;
      }
      .comment-form {
          margin-bottom: 20px;
          padding: 15px;
          background: #f5f5f5;
          border-radius: 5px;
      }
      .comment-form input, .comment-form textarea {
          width: 100%;
          padding: 8px;
          margin-bottom: 10px;
          border: 1px solid #ddd;
          border-radius: 4px;
      }
      .comment-form button {
          background: #4CAF50;
          color: white;
          padding: 10px 15px;
          border: none;
          border-radius: 4px;
          cursor: pointer;
      }
      .comment-form button:hover {
          background: #45a049;
      }
      .comments-list {
          list-style: none;
          padding: 0;
      }
      .comment-item {
          padding: 15px;
          margin-bottom: 10px;
          background: #fff;
          border: 1px solid #ddd;
          border-radius: 5px;
      }
      .comment-author {
          font-weight: bold;
          margin-bottom: 5px;
      }
      .comment-content {
          margin-bottom: 5px;
      }
      .comment-date {
          font-size: 0.8em;
          color: #666;
      }
	</style>
</head>
<body>
<h1>Комментарии</h1>

<div class="comment-form">
	<h2>Добавить комментарий</h2>
	<input type="number" id="templateId" placeholder="ID шаблона" value="27">
	<textarea id="commentContent" placeholder="Ваш комментарий"></textarea>
	<button id="submitComment">Отправить</button>
</div>

<h2>Список комментариев</h2>
<button id="loadComments">Загрузить комментарии</button>
<ul class="comments-list" id="commentsList"></ul>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
  // Ваш JWT токен
  const token = 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1lIjoiYWRtaW4iLCJlbWFpbCI6ImFkbWluQGdtYWlsLmNvbSIsImlkIjoxLCJyb2xlIjoiQURNSU4iLCJpYXQiOjE3NDQ5MDI4MTMsImV4cCI6MTc0NTUwNzYxM30.9CHHR4SR00QLW18xAOZphjuqROqFmTHH36SkCk01-4I';

  // Подключение к серверу
  const socket = io('http://localhost:3000', {
    auth: {
      token: token,
    },
  });

  // Элементы DOM
  const commentForm = document.querySelector('.comment-form');
  const templateIdInput = document.getElementById('templateId');
  const commentContentInput = document.getElementById('commentContent');
  const submitButton = document.getElementById('submitComment');
  const loadCommentsButton = document.getElementById('loadComments');
  const commentsList = document.getElementById('commentsList');

  // Обработчик подключения
  socket.on('connect', () => {
    console.log('Connected with ID:', socket.id);
  });

  // Обработчик ошибок
  socket.on('connect_error', (err) => {
    console.error('Connection error:', err);
    alert('Ошибка подключения: ' + err.message);
  });

  // Обработчик получения нового комментария
  socket.on('new_comment', (comment) => {
    console.log('New comment received:', comment);
    addCommentToDOM(comment);
  });

  // Обработчик получения списка комментариев
  socket.on('comments_list', (comments) => {
    console.log('Comments list received:', comments);
    commentsList.innerHTML = ''; // Очищаем список
    comments.forEach(comment => addCommentToDOM(comment));
  });

  // Добавление комментария в DOM
  function addCommentToDOM(comment) {
    const li = document.createElement('li');
    li.className = 'comment-item';

    const author = document.createElement('div');
    author.className = 'comment-author';
    author.textContent = comment.user?.name || 'Аноним';

    const content = document.createElement('div');
    content.className = 'comment-content';
    content.textContent = comment.content;

    const date = document.createElement('div');
    date.className = 'comment-date';
    date.textContent = new Date(comment.createdAt).toLocaleString();

    li.appendChild(author);
    li.appendChild(content);
    li.appendChild(date);

    commentsList.prepend(li); // Добавляем в начало списка
  }

  // Отправка комментария
  submitButton.addEventListener('click', () => {
    const templateId = parseInt(templateIdInput.value);
    const content = commentContentInput.value.trim();

    if (!templateId || !content) {
      alert('Пожалуйста, заполните все поля');
      return;
    }

    socket.emit('add_comment', {
      templateId: templateId,
      content: content
    });

    commentContentInput.value = ''; // Очищаем поле ввода
  });

  // Загрузка комментариев
  loadCommentsButton.addEventListener('click', () => {
    const templateId = parseInt(templateIdInput.value);
    if (!templateId) {
      alert('Пожалуйста, укажите ID шаблона');
      return;
    }
    socket.emit('get_comments', templateId);
  });

  // Можно также отправлять по нажатию Enter в поле комментария
  commentContentInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      submitButton.click();
    }
  });
</script>
</body>
</html>